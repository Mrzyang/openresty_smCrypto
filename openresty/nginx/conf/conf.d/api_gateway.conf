# API网关配置文件

# 上游后端服务
upstream backend_services {
    server 127.0.0.1:3000;
    keepalive 32;
}

# 设置Lua包路径
lua_package_path "/opt/zy/software/openresty/nginx/lua/?.lua;/opt/zy/software/openresty/nginx/lua/api_gateway/?.lua;;";
# 设置共享字典
lua_shared_dict nonce_cache 10m;
lua_shared_dict rate_limit 10m;

# 主API网关服务
server {
    listen 8082;
    server_name api-gateway.local;
        
    # 健康检查接口
    location /health {
        access_log off;
        content_by_lua_block {
            local gateway = require "api_gateway.gateway"
            gateway.health_check()
        }
    }
    
    # 管理接口
    location /admin/app {
        access_log off;
        content_by_lua_block {
            local gateway = require "api_gateway.gateway"
            gateway.get_app_info()
        }
    }
    
    location /admin/api {
        access_log off;
        content_by_lua_block {
            local gateway = require "api_gateway.gateway"
            gateway.get_api_info()
        }
    }
    
    location /admin/subscriptions {
        access_log off;
        content_by_lua_block {
            local gateway = require "api_gateway.gateway"
            gateway.get_app_subscriptions()
        }
    }
    
    # 测试端点
    location /test {
        lua_need_request_body on;
        content_by_lua_block {
            ngx.req.read_body()
            local body = ngx.req.get_body_data()
            ngx.header.content_type = "text/plain"
            ngx.say("收到的数据: ", body or "(empty)")
            ngx.say("数据长度: ", #(body or ""))
            
            -- 检查是否包含引号
            if body and string.find(body, '"') then
                ngx.say("警告: 数据包含引号")
            end
        }
    }
    
    # SM2验签调试端点
    location /debug/sm2_verify {
        content_by_lua_file /opt/zy/software/openresty/nginx/lua/sm_crypto/debug_sm2_verify.lua;
    }
    
    # PEM格式密钥加载测试端点
    location /debug/test_pem_loading {
        content_by_lua_file /opt/zy/software/openresty/nginx/lua/sm_crypto/test_pem_loading.lua;
    }
    
    # OpenResty兼容PEM格式测试端点
    location /debug/test_openssl_pem {
        content_by_lua_file /opt/zy/software/openresty/nginx/lua/sm_crypto/test_openssl_pem.lua;
    }
    
    # PEM格式兼容性比较测试端点
    location /debug/compare_pem_formats {
        content_by_lua_file /opt/zy/software/openresty/nginx/lua/sm_crypto/compare_pem_formats.lua;
    }
    
    # Redis PEM格式密钥测试端点
    location /debug/test_redis_pem {
        content_by_lua_file /opt/zy/software/openresty/nginx/lua/sm_crypto/test_redis_pem.lua;
    }
    
    # 新PEM格式密钥测试端点
    location /debug/test_new_pem_format {
        content_by_lua_file /opt/zy/software/openresty/nginx/lua/sm_crypto/test_new_pem_format.lua;
    }
    
    # 代理到后端服务
    location /proxy {
        internal;
        proxy_pass http://backend_services;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_buffering off;
    }
    
    # API网关主入口
    location /api/ {
        # 设置请求体大小限制
        client_max_body_size 10m;
        
        # 读取请求体
        lua_need_request_body on;
        
        # 主处理逻辑
        content_by_lua_block {
            local gateway = require "api_gateway.gateway"
            gateway.handle_request()
        }
        
        # 错误处理
        error_page 400 401 403 404 408 409 500 502 503 504 /error;
    }
    
    # 错误页面
    location = /error {
        internal;
        content_by_lua_block {
            local status = ngx.status
            local error_msg = "Internal Server Error"
            
            if status == 400 then
                error_msg = "Bad Request"
            elseif status == 401 then
                error_msg = "Unauthorized"
            elseif status == 403 then
                error_msg = "Forbidden"
            elseif status == 404 then
                error_msg = "Not Found"
            elseif status == 408 then
                error_msg = "Request Timeout"
            elseif status == 409 then
                error_msg = "Conflict"
            elseif status == 500 then
                error_msg = "Internal Server Error"
            elseif status == 502 then
                error_msg = "Bad Gateway"
            elseif status == 503 then
                error_msg = "Service Unavailable"
            elseif status == 504 then
                error_msg = "Gateway Timeout"
            end
            
            ngx.header.content_type = "application/json; charset=utf-8"
            ngx.say('{"code":' .. status .. ',"message":"' .. error_msg .. '","timestamp":' .. ngx.time() .. '}')
        }
    }
    
    # 静态文件服务（可选）
    location /static/ {
        alias /opt/zy/software/openresty/nginx/html/static/;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
}

# 日志格式
log_format api_gateway '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'rt=$request_time uct="$upstream_connect_time" '
                      'uht="$upstream_header_time" urt="$upstream_response_time" '
                      'appid="$http_x_app_id" nonce="$http_x_nonce"';

# 访问日志
access_log /opt/zy/software/openresty/nginx/logs/api_gateway_access.log api_gateway;
error_log /opt/zy/software/openresty/nginx/logs/api_gateway_error.log debug;
